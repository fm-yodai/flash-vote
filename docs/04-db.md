# Database (Postgres) + Migrations (Drizzle)

## 1. 方針
- DBはPostgres
- migrationはDrizzle
- スキーマ定義（単一の真実）: `packages/db/src/schema.ts`
- マイグレーション（Git管理）: `packages/db/drizzle/*/migration.sql`
- 適用は `drizzle-kit migrate` （アプリ起動時に自動migrateはしない。CIまたは手動で実行）
- host tokenは平文保存しない（hash + pepper）
- participantId + questionId はユニーク（同一質問への二重回答をDBで防ぐ）
- presenceは軽量に（参加者数の把握）

Drizzle Kit は `generate` でSQLマイグレーションを生成し、`migrate` で適用する運用を公式にサポートしている。

## 2. ディレクトリ構成
```
packages/db/
  drizzle/ # migration.sql + snapshots
  src/
    schema.ts # Drizzle schema definitions (tables/enums)
    client.ts # drizzle db client (node-postgres)
    index.ts  # exports
  drizzle.config.ts # drizzle-kit config
  packege.json
  tsconfig.json
```
`drizzle.config.ts` は `schema/out/dbCredentials` などを定義する。

## 3. コマンド（運用の型）
### 3.1 生成（generate）
スキーマ変更後にSQLマイグレーションを生成：
- `drizzle-kit generate` は `dialect` と `schema` を必要とし、config file でもCLIでも指定できる。

### 3.2 適用（migrate）
生成されたSQLマイグレーションをDBに適用：
- `drizzle-kit migrate` は migrationフォルダの `.sql` を読み、適用履歴テーブルを参照しながら未適用分を実行する。

## 4. 日常フロー（推奨：generate → review → migrate）
1) `packages/db/src/schema.ts` を編集
2) `pnpm db:generate`（SQL生成）
3) 生成された `migration.sql` をレビュー
4) `pnpm db:migrate`（適用）
5) アプリ動作確認

## 5. `push` は原則使わない（MVPチーム運用）
`drizzle-kit push` はSQL生成を省略してDBに直接反映できるが、チーム運用では意図しない変更が入りやすい。
原則は `generate + migrate` を採用する。

## 6. 本番適用（推奨）
- CIで `pnpm db:migrate` を実行してからデプロイ（またはデプロイジョブ内で順序保証）
- Vercelのスケール/並列でmigrateが複数走る事故を避ける（アプリ起動時にmigrateしない）

## 7. スキーマ要点（重要制約）
- responses: `unique(participant_id, question_id)` で二重回答をDBで防止
- questions: `unique(room_id, order)`
- participants: `unique(room_id, participant_id)`
- ai_proposals: `unique(room_id, version)`
